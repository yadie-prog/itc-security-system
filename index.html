<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Portal System</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .bg-itc { background-color: #1e293b; }
    #reader { width: 100%; border-radius: 15px; overflow: hidden; border: 2px solid #059669; margin-bottom: 15px; }
    #login-overlay { display: none; }
    @media (max-width: 640px) {
      header { padding-top: 50px !important; }
      .logout-btn { top: 10px !important; right: 10px !important; }
    }
    .status-badge { font-size: 9px; padding: 2px 8px; border-radius: 99px; font-weight: 800; text-transform: uppercase; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <div id="login-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 text-center">
      <div class="mb-6">
        <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
          <i class="fa fa-user-shield text-white text-3xl"></i>
        </div>
        <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">SESI SECURITY TERKUNCI</h2>
        <p class="text-slate-500 text-sm">Silahkan login untuk melanjutkan.</p>
      </div>
      <div class="text-left mb-4">
        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">NAMA YANG BERTUGAS</label>
        <input type="text" id="login-pic-name" placeholder="NAMA ANDA..." class="w-full p-4 border-2 rounded-xl text-center font-bold uppercase outline-none focus:border-blue-500">
      </div>
      <div class="text-left mb-6">
        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Password Security</label>
        <input type="password" id="login-password" placeholder="••••••••" class="w-full p-4 border-2 rounded-xl text-center font-bold outline-none focus:border-blue-500">
      </div>
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg active:scale-95 uppercase">Masuk Ke Sistem</button>
      <p class="mt-6 text-[10px] text-slate-400 font-bold uppercase tracking-widest">&copy; 2026 | DAC Media Project</p>
    </div>
  </div>

  <header class="bg-emerald-900 text-white py-6 shadow-md text-center relative">
    <div class="absolute right-4 top-4">
      <button onclick="handleLogout()" class="bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all border border-red-500/50 logout-btn">
        <i class="fa fa-power-off"></i> Logout
      </button>
    </div>
    <h2 class="text-xl font-black tracking-widest uppercase">SECURITY - INPUT SYSTEM</h2>
    <div class="flex justify-center items-center gap-4 mt-2">
       <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-tighter"><i class="fa fa-user-shield mr-1"></i>PETUGAS : <span id="display-pic-name">...</span></p>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-xl mx-auto bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
      <h3 class="text-center font-black text-slate-700 mb-6 border-b pb-4 uppercase tracking-tighter">Form Input Pergerakan Unit</h3>
      
      <div class="space-y-4">
        <div>
          <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Plat Nomor</label>
          <input id="i_plate" class="w-full p-4 border-2 rounded-xl text-center font-bold text-lg uppercase outline-none focus:border-emerald-500 bg-gray-50" placeholder="B 1234 XXX" oninput="this.value = this.value.replace(/\s/g, '').toUpperCase()">
        </div>

        <div class="bg-emerald-50 p-4 rounded-2xl border-2 border-emerald-100">
          <label class="text-[10px] font-bold text-emerald-600 uppercase ml-2">Surat Jalan (Scan QR / Manual)</label>
          <div class="flex gap-2 mb-3">
            <input id="i_park" class="flex-1 p-4 border-2 rounded-xl text-center font-bold text-lg uppercase outline-none focus:border-emerald-500" placeholder="SCAN ATAU KETIK..." oninput="this.value = this.value.replace(/\s/g, '').toUpperCase()">
            <button onclick="toggleScanner()" class="bg-emerald-600 text-white px-6 rounded-xl hover:bg-emerald-700 transition shadow-md active:scale-95">
              <i class="fa fa-qrcode text-xl"></i>
            </button>
          </div>
          <div id="reader" class="hidden mb-4"></div>
        </div>

        <div>
          <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Workstation</label>
          <select id="i_ws" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50">
              <option value="">-- Pilih Aktivitas --</option>
              <option>Stock In</option><option>Sold</option>
              <option>Test Drive Out</option><option>Test Drive In</option>
              <option>Body & Paint Out</option><option>Body & Paint In</option>
              <option>Out To PIO</option><option>In From PIO</option>
              <option>Out To Wismul</option><option>In From Wismul</option>
              <option>Rental Out</option><option>Rental In</option>
              <option>Courtesy Out</option><option>Courtesy In</option>
          </select>
        </div>

        <div>
          <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Fuel (BBM)</label>
          <select id="i_fuel" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50">
            <option value="">-- BBM --</option>
            <option>10%</option><option>20%</option><option>30%</option><option>40%</option><option>50%</option>
            <option>60%</option><option>70%</option><option>80%</option><option>90%</option><option>100%</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Driver</label>
            <input id="i_pem" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50" placeholder="Nama Driver">
          </div>
          <div>
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Customer</label>
            <input id="i_cust" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50" placeholder="Nama Customer">
          </div>
        </div>

        <button onclick="submitSecurityData()" class="w-full bg-emerald-600 text-white font-black py-5 rounded-2xl hover:bg-emerald-700 transition uppercase shadow-xl active:scale-95 text-lg mt-4">
          <i class="fa fa-save mr-2"></i> Simpan & Kirim
        </button>
      </div>
    </div>

    <div class="max-w-xl mx-auto mt-8 bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-black text-slate-700 uppercase tracking-tighter">History Input (Terbaru)</h3>
        <button onclick="syncAllPending()" class="text-[10px] bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-extrabold hover:bg-blue-200">
          <i class="fa fa-sync-alt mr-1"></i> SYNC PENDING
        </button>
      </div>
      <div class="space-y-3" id="history-container">
        </div>
    </div>
  </main>

  <footer class="py-6 text-center text-slate-400">
    <p class="text-[10px] font-bold uppercase tracking-widest">&copy; 2026 DAC MEDIA PROJECT | v1.9 STABLE</p>
  </footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzKnrP3KIq-wvGcw5CDUZ_an0JcAy2DPpWqLGBCLhWQReuGXu2qBU4vAvqz34adITQl/exec";
    let CURRENT_PIC = "";
    let html5QrCode;

    window.onload = () => {
      checkSession();
      renderHistory();
    };

    function checkSession() {
      const savedPic = localStorage.getItem("itc_pic_session");
      if (!savedPic) {
        document.getElementById("login-overlay").style.display = "flex";
      } else {
        CURRENT_PIC = savedPic;
        document.getElementById("display-pic-name").innerText = CURRENT_PIC;
        document.getElementById("login-overlay").style.display = "none";
      }
    }

    function handleLogin() {
      const name = document.getElementById("login-pic-name").value.trim().toUpperCase();
      const pass = document.getElementById("login-password").value;
      if (!name || pass !== "hsm2026") return Swal.fire('Error', 'Nama wajib diisi & Password harus benar!', 'error');
      localStorage.setItem("itc_pic_session", name);
      checkSession();
      Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Login Berhasil', showConfirmButton: false, timer: 2000 });
    }

    function handleLogout() {
      Swal.fire({ title: 'Logout?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then(res => {
        if (res.isConfirmed) { localStorage.removeItem("itc_pic_session"); location.reload(); }
      });
    }

    function toggleScanner() {
      const readerDiv = document.getElementById('reader');
      if (html5QrCode && html5QrCode.isScanning) { stopScanner(); return; }
      readerDiv.classList.remove('hidden');
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
        document.getElementById('i_park').value = txt.toUpperCase();
        stopScanner();
      }).catch(() => Swal.fire('Error', 'Gagal akses kamera', 'error'));
    }

    function stopScanner() {
      if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('reader').classList.add('hidden'));
    }

    // --- CORE LOGIC: LOCAL HISTORY & QUEUE ---

    function submitSecurityData() {
      const plate = document.getElementById('i_plate').value.trim();
      const park = document.getElementById('i_park').value.trim();
      const ws = document.getElementById('i_ws').value;
      const fuel = document.getElementById('i_fuel').value;
      const pem = document.getElementById('i_pem').value.trim();
      const cust = document.getElementById('i_cust').value.trim();

      if(!plate || !park || !ws || !pem) return Swal.fire('Peringatan', 'Lengkapi data bertanda wajib!', 'warning');

      const entryId = "ID-" + Date.now();
      const dataEntry = {
        id: entryId,
        plate: plate.toUpperCase(),
        parking: park.toUpperCase(),
        lot: "-",
        workstation: ws,
        fuel: fuel,
        peminjam: pem.toUpperCase(),
        customer: cust.toUpperCase() || "-",
        pic: CURRENT_PIC,
        timestamp: new Date().toLocaleTimeString(),
        status: "pending"
      };

      saveToLocal(dataEntry);
      resetForm();
      processRequest(entryId);
    }

    function saveToLocal(entry) {
      let history = JSON.parse(localStorage.getItem("itc_security_history") || "[]");
      history.unshift(entry);
      if(history.length > 20) history.pop(); // Simpan 20 data terakhir saja
      localStorage.setItem("itc_security_history", JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem("itc_security_history") || "[]");
      const container = document.getElementById("history-container");
      
      if(history.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-400 text-xs py-4">Belum ada input hari ini.</p>`;
        return;
      }

      container.innerHTML = history.map(item => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-2xl border border-gray-100">
          <div>
            <div class="font-black text-slate-700">${item.plate}</div>
            <div class="text-[9px] text-gray-400 font-bold uppercase">${item.workstation} • ${item.timestamp}</div>
          </div>
          <div class="flex items-center gap-3">
            <span class="status-badge ${item.status === 'success' ? 'bg-green-100 text-green-600' : 'bg-amber-100 text-amber-600'}">
              ${item.status}
            </span>
            ${item.status === 'pending' ? 
              `<button onclick="processRequest('${item.id}')" class="w-8 h-8 bg-blue-500 text-white rounded-full text-xs shadow-lg active:scale-90 flex items-center justify-center">
                <i class="fa fa-paper-plane"></i>
              </button>` : 
              `<i class="fa fa-check-circle text-green-500 text-lg"></i>`
            }
          </div>
        </div>
      `).join('');
    }

    async function processRequest(id) {
      let history = JSON.parse(localStorage.getItem("itc_security_history") || "[]");
      const index = history.findIndex(i => i.id === id);
      if(index === -1 || history[index].status === "success") return;

      const payload = { ...history[index] };
      delete payload.id; delete payload.status; delete payload.timestamp;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const result = await response.json();

        if(result.status === "success") {
          updateStatus(id, "success");
        }
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }

    function updateStatus(id, newStatus) {
      let history = JSON.parse(localStorage.getItem("itc_security_history") || "[]");
      const index = history.findIndex(i => i.id === id);
      if(index !== -1) {
        history[index].status = newStatus;
        localStorage.setItem("itc_security_history", JSON.stringify(history));
        renderHistory();
      }
    }

    function syncAllPending() {
      const history = JSON.parse(localStorage.getItem("itc_security_history") || "[]");
      const pending = history.filter(i => i.status === "pending");
      if(pending.length === 0) return Swal.fire('Info', 'Semua data sudah terkirim.', 'info');
      
      Swal.fire({ title: 'Menyinkronkan...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      Promise.all(pending.map(i => processRequest(i.id))).then(() => {
        Swal.fire({ icon: 'success', title: 'Sinkronisasi Selesai', timer: 1500 });
      });
    }

    function resetForm() {
      document.getElementById('i_plate').value = "";
      document.getElementById('i_park').value = "";
      document.getElementById('i_ws').value = "";
      document.getElementById('i_fuel').value = "";
      document.getElementById('i_pem').value = "";
      document.getElementById('i_cust').value = "";
    }
  </script>
</body>
</html>
