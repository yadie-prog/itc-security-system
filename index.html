<html lang="id">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .bg-itc { background-color: #1e293b; }
    .swal2-input-custom { width: 95%; margin: 8px auto; padding: 12px; border: 1px solid #ccc; border-radius: 8px; display: block; font-size: 16px; }
    #reader { width: 100%; border-radius: 15px; overflow: hidden; border: 2px solid #059669; margin-bottom: 15px; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #22c55e; margin-right: 5px; animation: blink 1.5s infinite; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    #login-overlay { display: none; }
    .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    
    @media (max-width: 640px) {
      header { padding-top: 50px !important; }
      .logout-btn { top: 10px !important; right: 10px !important; }
      .table-responsive { font-size: 10px; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <div id="login-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 text-center">
      <div class="mb-6">
        <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
          <i class="fa fa-user-shield text-white text-3xl"></i>
        </div>
        <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">SESI SECURITY TERKUNCI</h2>
      </div>
      <div class="text-left mb-4">
        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">NAMA YANG BERTUGAS</label>
        <input type="text" id="login-pic-name" placeholder="NAMA ANDA..." class="w-full p-4 border-2 rounded-xl text-center font-bold uppercase outline-none focus:border-blue-500">
      </div>
      <div class="text-left mb-6">
        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Password Security</label>
        <input type="password" id="login-password" placeholder="••••••••" class="w-full p-4 border-2 rounded-xl text-center font-bold outline-none focus:border-blue-500">
      </div>
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg active:scale-95 uppercase">Masuk Ke Sistem</button>
    </div>
  </div>

  <header class="bg-emerald-900 text-white py-6 shadow-md text-center relative">
    <div class="absolute right-4 top-4">
      <button onclick="handleLogout()" class="bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all border border-red-500/50">
        <i class="fa fa-power-off"></i> Logout
      </button>
    </div>
    <h2 class="text-xl font-black tracking-widest uppercase">SECURITY - INPUT SYSTEM</h2>
    <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-tighter mt-2"><i class="fa fa-user-shield mr-1"></i>PETUGAS : <span id="display-pic-name">...</span></p>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-xl mx-auto bg-white p-6 rounded-3xl shadow-xl border border-gray-100 mb-8">
      <h3 class="text-center font-black text-slate-700 mb-6 border-b pb-4 uppercase tracking-tighter">Form Input Pergerakan Unit</h3>
      
      <div class="space-y-4">
        <div>
          <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Plat Nomor</label>
          <input id="i_plate" class="w-full p-4 border-2 rounded-xl text-center font-bold text-lg uppercase outline-none focus:border-emerald-500 bg-gray-50" placeholder="B 1234 XXX" oninput="this.value = this.value.replace(/\s/g, '').toUpperCase()">
        </div>

        <div class="bg-emerald-50 p-4 rounded-2xl border-2 border-emerald-100">
          <label class="text-[10px] font-bold text-emerald-600 uppercase ml-2">Surat Jalan (Scan QR / Manual)</label>
          <div class="flex gap-2 mb-3">
            <input id="i_park" class="flex-1 p-4 border-2 rounded-xl text-center font-bold text-lg uppercase outline-none focus:border-emerald-500" placeholder="SCAN ATAU KETIK..." oninput="this.value = this.value.replace(/\s/g, '').toUpperCase()">
            <button onclick="toggleScanner()" class="bg-emerald-600 text-white px-6 rounded-xl">
              <i class="fa fa-qrcode text-xl"></i>
            </button>
          </div>
          <div id="reader" class="hidden mb-4"></div>
        </div>

        <input type="hidden" id="i_lot" value="-">

        <div>
          <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Workstation</label>
          <select id="i_ws" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50">
              <option value="">-- Pilih Aktivitas --</option>
              <option>Stock In</option><option>Sold</option>
              <option>Test Drive Out</option><option>Test Drive In</option>
              <option>Body & Paint Out</option><option>Body & Paint In</option>
              <option>Out To PIO</option><option>In From PIO</option>
              <option>Out To Wismul</option><option>In From Wismul</option>
              <option>Rental Out</option><option>Rental In</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Fuel</label>
            <select id="i_fuel" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50">
              <option value="">-- BBM --</option>
              <option>10%</option><option>50%</option><option>100%</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Driver</label>
            <input id="i_pem" class="w-full p-4 border-2 rounded-xl font-bold uppercase outline-none focus:border-emerald-500 bg-gray-50" placeholder="Nama Driver">
          </div>
        </div>

        <button onclick="submitSecurityData()" class="w-full bg-emerald-600 text-white font-black py-5 rounded-2xl hover:bg-emerald-700 transition uppercase shadow-xl active:scale-95 text-lg mt-4">
          <i class="fa fa-save mr-2"></i> Simpan Data
        </button>
      </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100">
      <div class="bg-slate-800 p-4 flex justify-between items-center">
        <h4 class="text-white font-bold uppercase text-xs tracking-widest"><i class="fa fa-history mr-2 text-emerald-400"></i>History Input Hari Ini</h4>
        <button onclick="clearHistory()" class="text-[9px] bg-red-500/20 text-red-400 px-2 py-1 rounded border border-red-500/30 uppercase font-bold">Hapus History</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse table-responsive">
          <thead class="bg-slate-50 border-b border-gray-100">
            <tr>
              <th class="p-4 text-[10px] font-bold text-gray-400 uppercase">Waktu</th>
              <th class="p-4 text-[10px] font-bold text-gray-400 uppercase">Unit</th>
              <th class="p-4 text-[10px] font-bold text-gray-400 uppercase">Aktivitas</th>
              <th class="p-4 text-[10px] font-bold text-gray-400 uppercase">Driver</th>
              <th class="p-4 text-center text-[10px] font-bold text-gray-400 uppercase">Aksi</th>
            </tr>
          </thead>
          <tbody id="history-body">
            </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="py-6 text-center text-slate-400">
    <p class="text-[10px] font-bold uppercase tracking-widest">&copy; 2026 DAC MEDIA PROJECT | v1.9 (With History)</p>
  </footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzKnrP3KIq-wvGcw5CDUZ_an0JcAy2DPpWqLGBCLhWQReuGXu2qBU4vAvqz34adITQl/exec";
    let CURRENT_PIC = "";
    let html5QrCode;

    window.onload = () => {
      checkSession();
      renderHistory();
    };

    function checkSession() {
      const savedPic = localStorage.getItem("itc_pic_session");
      if (!savedPic) {
        document.getElementById("login-overlay").style.display = "flex";
      } else {
        CURRENT_PIC = savedPic;
        document.getElementById("display-pic-name").innerText = CURRENT_PIC;
        document.getElementById("login-overlay").style.display = "none";
      }
    }

    function handleLogin() {
      const name = document.getElementById("login-pic-name").value.trim().toUpperCase();
      const pass = document.getElementById("login-password").value;
      if (!name || pass !== "hsm2026") return Swal.fire('Error', 'Data login salah!', 'error');
      localStorage.setItem("itc_pic_session", name);
      checkSession();
    }

    function handleLogout() {
      localStorage.removeItem("itc_pic_session");
      location.reload();
    }

    // --- FITUR QR SCANNER ---
    function toggleScanner() {
      const readerDiv = document.getElementById('reader');
      if (html5QrCode && html5QrCode.isScanning) { stopScanner(); return; }
      readerDiv.classList.remove('hidden');
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
        document.getElementById('i_park').value = decodedText.toUpperCase();
        stopScanner();
      }).catch(err => Swal.fire('Error', 'Kamera Error', 'error'));
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById('reader').classList.add('hidden');
        });
      }
    }

    // --- FITUR HISTORY & RESEND ---
    function saveToHistory(data) {
      let history = JSON.parse(localStorage.getItem("sec_history") || "[]");
      const timestamp = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
      data.time = timestamp;
      history.unshift(data); // Tambah ke paling atas
      if (history.length > 10) history.pop(); // Batasi 10 data terakhir
      localStorage.setItem("sec_history", JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem("sec_history") || "[]");
      const body = document.getElementById("history-body");
      body.innerHTML = history.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-400 text-xs italic uppercase">Belum ada data input</td></tr>' : "";
      
      history.forEach((item, index) => {
        body.innerHTML += `
          <tr class="border-b border-gray-50 hover:bg-emerald-50 transition">
            <td class="p-4 font-bold text-slate-600">${item.time}</td>
            <td class="p-4 font-black text-emerald-700">${item.plate}</td>
            <td class="p-4 text-xs font-medium text-slate-500">${item.workstation}</td>
            <td class="p-4 text-xs text-slate-500">${item.peminjam}</td>
            <td class="p-4 text-center">
              <button onclick='resendData(${JSON.stringify(item)})' class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-[9px] font-bold uppercase hover:bg-blue-600 hover:text-white transition">
                <i class="fa fa-redo mr-1"></i> Resend
              </button>
            </td>
          </tr>
        `;
      });
    }

    function resendData(item) {
      document.getElementById('i_plate').value = item.plate;
      document.getElementById('i_park').value = item.parking;
      document.getElementById('i_ws').value = item.workstation;
      document.getElementById('i_fuel').value = item.fuel;
      document.getElementById('i_pem').value = item.peminjam;
      
      Swal.fire({
        toast: true,
        position: 'top',
        icon: 'info',
        title: 'Data dimuat kembali ke form',
        showConfirmButton: false,
        timer: 1500
      });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearHistory() {
      localStorage.removeItem("sec_history");
      renderHistory();
    }

    // --- SUBMIT DATA ---
    function submitSecurityData() {
      const data = {
        plate: document.getElementById('i_plate').value.trim().toUpperCase(),
        parking: document.getElementById('i_park').value,
        lot: "-", 
        workstation: document.getElementById('i_ws').value,
        fuel: document.getElementById('i_fuel').value,
        peminjam: document.getElementById('i_pem').value,
        pic: CURRENT_PIC
      };

      if(!data.plate || !data.workstation || !data.peminjam) {
        return Swal.fire('Peringatan', 'Lengkapi data wajib!', 'warning');
      }

      Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === "success") {
          Swal.fire({ icon:'success', title:'Tersimpan', timer: 1500 });
          saveToHistory(data); // Simpan ke history lokal
          // Reset Form
          ['i_plate', 'i_park', 'i_ws', 'i_fuel', 'i_pem'].forEach(id => document.getElementById(id).value = "");
        }
      })
      .catch(err => Swal.fire('Error', 'Koneksi Gagal', 'error'));
    }
  </script>
</body>
</html>
